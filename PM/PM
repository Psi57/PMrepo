--check if http is enabled.
if not http then
    printError("Http is disabled,please set http_enable to true in ComputerCraft.cfg")
    return
end
--".information" preservation information of program that installed by PM
if not fs.isDir (".information") then
    fs.makeDir(".information")
    print("PS:.information is a important dir of PM,Don't delete or modify it.Thanks.")
end

local url = "https://raw.githubusercontent.com/wuxiangdong/PMrero/master/"
local index = {} --programs
local need = {}

local function init()
    local text
    --load index
    local response = http.get(url .. "index")
    if not response then 
        printError("Get index unsuccessfully")
        return false 
    end
    text = response.readLine()
    while text ~= EOF do
        index[text] = true
        text = response.readLine()
    end
    print("Get index successfully")
    response.close()
    print("Try input \"help\"")
    return true
end
    
    if not init() then
        printError("Init error")
        return
    end

local function install(name)
    if(index[name]) then 
        local response = http.get(url .. name .. "/need")
        local text = response.readLine()
        while text ~= EOF do 
            if not install (text) then
                printError("Install unsuccessfully.Dependency of " .. name .. "can't install.")
                return false
            end
            local r1 = http.get(url .. name .. "/version")
            local f1 =fs.open(".information/" .. text,"w")
            f1.write(r1.readAll() .. " dependency")
            f1.close()
            r1.close()
            text = response.readLine()
        end
        response.close()
        response = http.get(url .. name .. "/" .. name)
        local f = fs.open(name, "w")
        f.write(response.readAll())
        f.close()
        response.close()
        response = http.get(url .. name .. "/version")
        f =fs.open(".information/" .. text,"w")
        f.write(r1.readAll())
        f.close()
        response.close()        
        return true
        
    end
end
local function help()
    print("Usages:")
    print("index: show the list of files name")
    print("install <filename>: install the file to local")
    print("exit: exit this program")
    print("Thank xia for opening his program")
end
while true do
    local input = ""
    io.write("#")
    input = read()
    local location = string.find(input , " ")
    local parameter = string.sub(input, location + 1)
    local command = string.sub(input, 1,location - 1)
    if location then
        if(command == "install")then
            if(fs.exists(parameter))then
                print(parameter .. " is installed,Do you want to reinstall it?(Y/N)")
                input=read()
                if(input=="Y" or input=="y")then
                    install(parameter)
                end
            else install(parameter) end
        end
    elseif(input=="index")then
        print("")
        print(index)
    elseif(input=="help")then
        print("")
        help()
    elseif(input=="exit")then
        print("goodbye!")
        return
    else
        print(input .. "is not a command")
        print("Try input \"help\"")
    end
end
--version 0.1
